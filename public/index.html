<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AR con Imágenes Naturales y Modelo GLB</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #info {
        position: absolute;
        top: 10px;
        left: 10px;
        color: white;
        background: rgba(0, 0, 0, 0.5);
        padding: 10px;
        font-family: Arial;
      }
      #loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        background: rgba(0, 0, 0, 0.7);
        padding: 20px;
        border-radius: 10px;
        font-family: Arial;
      }
    </style>
  </head>
  <body>
    <div id="info">
      Apunte a una imagen con buen contraste (como un libro, revista o poster)
    </div>
    <div id="loading">Cargando modelo 3D...</div>

    <script>
      // 1. Configuración inicial
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(
        60,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      const renderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: true,
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      // 2. Configuración de AR.js para imágenes naturales
      const arToolkitSource = new THREEx.ArToolkitSource({
        sourceType: "webcam",
      });

      const arToolkitContext = new THREEx.ArToolkitContext({
        cameraParametersUrl:
          "https://raw.githack.com/AR-js-org/AR.js/master/data/data/camera_para.dat",
        detectionMode: "mono_natural",
        maxDetectionRate: 30,
        canvasWidth: 640,
        canvasHeight: 480,
      });

      // 3. Controlador para el tracking natural
      const markerRoot = new THREE.Group();
      scene.add(markerRoot);

      const arMarkerControls = new THREEx.ArMarkerControls(
        arToolkitContext,
        markerRoot,
        {
          type: "pattern",
          descriptorsUrl: "patterns/marker.patt",
          changeMatrixMode: "cameraTransformMatrix",
        }
      );

      // 4. Cargar modelo GLB
      const loader = new THREE.GLTFLoader();
      let model;

      // Reemplaza esta URL con la de tu modelo GLB
      const modelUrl = "models/patricio.glb";

      loader.load(
        modelUrl,
        (gltf) => {
          model = gltf.scene;
          // Ajusta estos valores según tu modelo
          model.scale.set(0.1, 0.1, 0.1);
          model.position.y = 0.05;
          model.rotation.y = Math.PI;
          markerRoot.add(model);
          document.getElementById("loading").style.display = "none";
        },
        (xhr) => {
          // Muestra progreso de carga
          const percent = ((xhr.loaded / xhr.total) * 100).toFixed(2);
          document.getElementById(
            "loading"
          ).textContent = `Cargando modelo 3D... ${percent}%`;
        },
        (error) => {
          console.error("Error al cargar el modelo:", error);
          document.getElementById("loading").textContent =
            "Error al cargar el modelo";
        }
      );

      // 5. Iluminación
      const ambientLight = new THREE.AmbientLight(0xffffff, 1.0);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(1, 1, 0.5);
      scene.add(directionalLight);

      // 6. Bucle de renderizado
      function animate() {
        requestAnimationFrame(animate);

        if (arToolkitSource.ready) {
          arToolkitContext.update(arToolkitSource.domElement);
          scene.visible = camera.visible;
        }

        renderer.render(scene, camera);
      }

      // 7. Inicialización
      arToolkitSource.init(() => {
        arToolkitContext.init(() => {
          camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
          animate();
        });
      });

      // 8. Manejar redimensionamiento
      window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    </script>
  </body>
</html>
